### 数据库索引结构

由于数据库数据全部存储在磁盘中，相比内存数据，更加注重数据的高效读取。因此，索引本质上就是为了帮助从磁盘中快速定位数据。不论MySQL、Oracle或是其他数据库，索引的结构差不多，都是一种排好序的数据结构。

<img src="https://imagebag.oss-cn-chengdu.aliyuncs.com/img/image-20210718163658677.png" alt="image-20210718163658677" style="zoom:67%;" />

### 无索引

一种最简单的数据存放结构就是无索引顺序存储，因此根据MySQL语句读取一行记录时，就需要从磁盘中将表记录依次全部读取出来，另外，磁盘在存储数据本身时，多个文件之间也不是顺序存储的，这将造成IO瓶颈。

### 二叉树

建立索引的最简单的一种数据结构即是二叉树，这样根据索引可以较快速定位到某个节点上，再根据节点信息定位到数据位置（磁盘信息），将大大减少IO。更高级的一些做法是采用平衡二叉树，红黑树。

### B-Tree

最终数据库索引结构没有采用二叉树之类的形式，原因在于，当表的记录数足够多时，树的深度还是会很深，通常达到10-20层，每一次向下查找都会发起一次新的IO请求，这将导致慢查询，因此采用了B树这样一种形式。

<img src="https://imagebag.oss-cn-chengdu.aliyuncs.com/img/image-20210718164536334.png" alt="image-20210718164536334" style="zoom: 80%;" />

特点：

- 叶节点具有相同的深度，叶节点的指针为空
- 所有索引元素不重复
- 节点中的数据索引从左到右递增排列

采用这样的索引结构，树的深度急剧减低，（B+树的深度通常仅为3层）配合二分查找，可以快速定位到某一个节点。

### B+Tree

<img src="https://imagebag.oss-cn-chengdu.aliyuncs.com/img/image-20210718165053891.png" alt="image-20210718165053891" style="zoom:67%;" />

- 非叶子节点不存储data，只存储索引(冗余)，可以放更多的索引，降低深度
- 叶子节点包含所有索引字段
- 叶子节点用指针连接，提高区间访问的性能

B+树这样一种“冗余”特性，使得非叶子节点索引更加密集，因此每一层也就能存储更多的节点。MySQL通常将每一页数据大小限定为16KB，假如索引数据为大整型（bigint），占用8B，地址也按照8B来计算，那么一层一共有1024个节点，聚集索引（叶节点存储所有字段的索引结构）叶节点就算单个节点按照1KB来算，也能存储16个节点，那么三层就能存储16M的数据，足以支撑百万级别的记录数。

### 数据-索引文件

![image-20210718165735215](https://imagebag.oss-cn-chengdu.aliyuncs.com/img/image-20210718165735215.png)

#### myisam引擎——非聚集索引

- frm：表结构
- MYD：表记录
- MYI：索引

MyISAM索引文件和数据文件是分离的。

<img src="https://imagebag.oss-cn-chengdu.aliyuncs.com/img/image-20210718170202298.png" alt="image-20210718170202298" style="zoom:67%;" />

#### innodb——聚集索引

- frm：表结构
- ibd：索引+数据

表数据文件本身就是按B+Tree组织的一个索引结构文件，聚集索引-叶节点包含了完整的数据记录，如图所示是主键索引。

![image-20210718170315344](https://imagebag.oss-cn-chengdu.aliyuncs.com/img/image-20210718170315344.png)

如图所示对应的二级索引就不是聚集索引，叶节点一般存储主键，为了节省空间和一致性，当然了，因为多了一次回表操作，因此查询时间会增加。

![image-20210718170429873](https://imagebag.oss-cn-chengdu.aliyuncs.com/img/image-20210718170429873.png)

通过索引结构可以发现，索引的记录一般采用整形且自增，将有助于建立索引，良好的设计实践是，在主键约束中添加上`auto_increment`，

### Hash

<img src="https://imagebag.oss-cn-chengdu.aliyuncs.com/img/image-20210718170941560.png" alt="image-20210718170941560" style="zoom: 80%;" />

- 对索引的key进行一次hash计算就可以定位出数据存储的位置
- 很多时候Hash索引要比B+ 树索引更高效
- 仅能满足 “=”，“IN”，不支持范围查询
- hash冲突问题

前两点都能说明Hash结构的索引在查询复杂度上更加简单，设计也更加简单。虽然存在hash冲突问题，但将数据load入内存中，再逐个比对所花时间也不长。最严重的问题在于结构的无序性，hash相较树形结构，由于天然的无序性，导致不支持范围查询，字符串的like查询等，而B-Tree则很好的支持了这些方式。B+Tree叶节点的前后指针也提高了这些操作的性能。

### 联合索引

<img src="https://imagebag.oss-cn-chengdu.aliyuncs.com/img/image-20210718171553003.png" alt="image-20210718171553003" style="zoom:67%;" />

多个字段共同组成的一种索引，也可以实现为B+Tree，其实和java中的对象排序方法类似，按照"左前列"原则进行排序，良好的设计实践是，当采用联合索引查询记录时，按照"左前列"原则设计sql查询语句，否则有可能不走索引，或走部分索引。

